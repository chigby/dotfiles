#!/usr/bin/env python

import re
import sys
import textwrap
from email.parser import Parser
from email.header import Header

def just_names(email):
    email = re.sub(r'\s+', ' ', email)
    email = re.sub(r'<[^>]+>', '', email)
    email = email.strip()
    return email

def others(number):
    if number < 1:
        return ''
    if number == 1:
        plural = ''
    else:
        plural = 's'
    return ', and {0} other{1}.'.format(number, plural)

def is_too_long(txt):
    wrapped = Header(txt).encode()
    return wrapped.count('\n') > 1

def make_shorter(a):
    if not is_too_long(a):
        return a
    emails = a.replace('\n', '').split(',')
    p = map(just_names, emails)
    excess = []
    s = textwrap.fill(', '.join(p) + others(len(excess)))
    while s.count('\n') > 1:
        excess.append(p.pop())
        s = textwrap.fill(', '.join(p) + others(len(excess)))
    return s

p = Parser()
msg = p.parse(sys.stdin, headersonly=True)

if msg['To']:
    msg.replace_header('To', make_shorter(msg['To']))
for cc in ('CC', 'Cc', 'cc'):
    if msg[cc]:
        msg.replace_header(cc, make_shorter(msg[cc]))
        break

print msg.as_string()
